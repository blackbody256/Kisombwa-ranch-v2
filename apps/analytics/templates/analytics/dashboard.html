<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KRIS Manager Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #f1f4f8;
      --ink: #132032;
      --muted: #5f6f82;
      --card: #ffffff;
      --line: #d6dfeb;
      --accent: #2a7f62;
      --accent-2: #f2b84b;
      --alert: #b84545;
    }
    body {
      background:
        radial-gradient(circle at 20% -20%, #dcecf4 0%, transparent 40%),
        radial-gradient(circle at 110% 10%, #eaf1db 0%, transparent 35%),
        var(--bg);
      color: var(--ink);
      font-family: "Manrope", sans-serif;
      min-height: 100vh;
    }
    .shell { max-width: 1240px; }
    .panel {
      border: 1px solid var(--line);
      border-radius: 16px;
      background: var(--card);
      box-shadow: 0 8px 28px rgba(19, 32, 50, 0.06);
    }
    .panel-header {
      border-bottom: 1px solid var(--line);
      padding: 14px 18px;
      font-weight: 700;
    }
    .panel-body { padding: 18px; }
    .kpi {
      padding: 14px 16px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: linear-gradient(145deg, #ffffff, #f7fafc);
      height: 100%;
    }
    .kpi .label { color: var(--muted); font-size: .82rem; }
    .kpi .value { font-size: 1.8rem; font-weight: 800; line-height: 1.1; }
    .metric-pill {
      display: inline-block;
      border-radius: 999px;
      background: #e8f4ef;
      color: var(--accent);
      font-size: .75rem;
      padding: 4px 10px;
      font-weight: 700;
    }
    .table > :not(caption) > * > * { border-bottom-color: var(--line); }
    .subtle { color: var(--muted); font-size: .9rem; }
    .impact { font-size: .9rem; font-weight: 700; color: var(--alert); }
  </style>
</head>
<body>
  <div class="container shell py-4 py-md-5">
    <div class="d-flex flex-wrap gap-3 justify-content-between align-items-center mb-4">
      <div>
        <div class="metric-pill mb-2">Manager Analytics</div>
        <h1 class="h3 fw-bold mb-1">KRIS Breeding & Herd Performance Dashboard</h1>
        <p class="subtle mb-0">Operational records from mobile app aggregated into management insights.</p>
      </div>
      <a href="/api/analytics/dashboard/" class="btn btn-dark btn-sm">Open JSON API</a>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-6 col-lg-3"><div class="kpi"><div class="label">Total Animals</div><div class="value">{{ kpis.total_animals }}</div></div></div>
      <div class="col-6 col-lg-3"><div class="kpi"><div class="label">Active Animals</div><div class="value">{{ kpis.active_animals }}</div></div></div>
      <div class="col-6 col-lg-3"><div class="kpi"><div class="label">Overdue Vaccinations</div><div class="value">{{ kpis.overdue_vaccinations }}</div></div></div>
      <div class="col-6 col-lg-3"><div class="kpi"><div class="label">Recent Mortality (30d)</div><div class="value">{{ kpis.recent_mortality_30_days }}</div></div></div>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-12">
        <section class="panel">
          <div class="panel-header">1. Breeding Performance Analyzer: Imported vs Local</div>
          <div class="panel-body">
            <div class="table-responsive mb-3">
              <table class="table align-middle mb-0">
                <thead>
                  <tr>
                    <th>Metric</th>
                    <th class="text-end">Imported</th>
                    <th class="text-end">Local</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Conception Rate</td>
                    <td class="text-end">{{ breeding_analyzer.comparison.0.conception_rate }}%</td>
                    <td class="text-end">{{ breeding_analyzer.comparison.1.conception_rate }}%</td>
                  </tr>
                  <tr>
                    <td>Stillbirth Rate</td>
                    <td class="text-end">{{ breeding_analyzer.comparison.0.stillbirth_rate }}%</td>
                    <td class="text-end">{{ breeding_analyzer.comparison.1.stillbirth_rate }}%</td>
                  </tr>
                  <tr>
                    <td>Calf Survival</td>
                    <td class="text-end">{{ breeding_analyzer.comparison.0.calf_survival_rate }}%</td>
                    <td class="text-end">{{ breeding_analyzer.comparison.1.calf_survival_rate }}%</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <p class="mb-1"><strong>Root Cause:</strong> {{ breeding_analyzer.root_cause.message }}</p>
            <p class="impact mb-1">Correlation impact: {{ breeding_analyzer.root_cause.correlation_impact }}% conception gap</p>
            <p class="mb-0"><strong>Recommendation:</strong> {{ breeding_analyzer.recommendation.action }} Estimated recoverable pregnancies: {{ breeding_analyzer.recommendation.estimated_recoverable_pregnancies }}.</p>
          </div>
        </section>
      </div>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-12 col-xl-7">
        <section class="panel h-100">
          <div class="panel-header">2. Health Correlation Charts</div>
          <div class="panel-body">
            <canvas id="healthChart" height="130"></canvas>
          </div>
        </section>
      </div>
      <div class="col-12 col-xl-5">
        <section class="panel h-100">
          <div class="panel-header">3. Herd Overview</div>
          <div class="panel-body">
            <div class="table-responsive mb-3">
              <table class="table table-sm mb-0">
                <thead><tr><th>Species</th><th class="text-end">Count</th></tr></thead>
                <tbody>
                  {% for row in herd_overview.animals_by_species %}
                    <tr><td>{{ row.species|title }}</td><td class="text-end">{{ row.total }}</td></tr>
                  {% empty %}
                    <tr><td colspan="2" class="text-center subtle">No records</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="subtle">
              Latest herd count discrepancy:
              <strong>{{ kpis.last_count_difference }}</strong>
              {% if herd_overview.latest_count %}
                on {{ herd_overview.latest_count.count_date }}
              {% endif %}
            </div>
          </div>
        </section>
      </div>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-12 col-xl-7">
        <section class="panel h-100">
          <div class="panel-header">4. Financial Performance</div>
          <div class="panel-body">
            <div class="row g-3 mb-3">
              <div class="col-6"><div class="kpi"><div class="label">Vaccination Cost</div><div class="value">${{ financial_performance.vaccine_cost }}</div></div></div>
              <div class="col-6"><div class="kpi"><div class="label">Treatment Cost</div><div class="value">${{ financial_performance.treatment_cost }}</div></div></div>
              <div class="col-6"><div class="kpi"><div class="label">Mortality Loss</div><div class="value">${{ financial_performance.mortality_loss }}</div></div></div>
              <div class="col-6"><div class="kpi"><div class="label">Estimated Revenue</div><div class="value">${{ financial_performance.estimated_revenue }}</div></div></div>
            </div>
            <p class="mb-0"><strong>Total costs:</strong> ${{ financial_performance.total_costs }} | <strong>ROI:</strong> {{ financial_performance.roi_percent }}%</p>
          </div>
        </section>
      </div>
      <div class="col-12 col-xl-5">
        <section class="panel h-100">
          <div class="panel-header">Breeding Source Chart</div>
          <div class="panel-body">
            <canvas id="breedingChart" height="180"></canvas>
          </div>
        </section>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-12 col-xl-6">
        <section class="panel h-100">
          <div class="panel-header">Recent Breeding Events</div>
          <div class="panel-body p-0">
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead><tr><th class="ps-3">Female Tag</th><th>Service Date</th><th class="text-end pe-3">Pregnancy</th></tr></thead>
                <tbody>
                  {% for row in recent.breeding %}
                    <tr><td class="ps-3">{{ row.female_tag_id }}</td><td>{{ row.service_date }}</td><td class="text-end pe-3">{{ row.pregnancy_confirmed }}</td></tr>
                  {% empty %}
                    <tr><td colspan="3" class="text-center subtle py-3">No breeding records</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
      <div class="col-12 col-xl-6">
        <section class="panel h-100">
          <div class="panel-header">Recent Health Events</div>
          <div class="panel-body p-0">
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead><tr><th class="ps-3">Animal</th><th>Event Date</th><th class="text-end pe-3">Type</th></tr></thead>
                <tbody>
                  {% for row in recent.vaccinations %}
                    <tr><td class="ps-3">{{ row.animal_tag_id }}</td><td>{{ row.date_administered }}</td><td class="text-end pe-3">Vaccination</td></tr>
                  {% endfor %}
                  {% for row in recent.mortality %}
                    <tr><td class="ps-3">{{ row.animal_tag_id }}</td><td>{{ row.death_date }}</td><td class="text-end pe-3">Mortality</td></tr>
                  {% endfor %}
                  {% if not recent.vaccinations and not recent.mortality %}
                    <tr><td colspan="3" class="text-center subtle py-3">No health records</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  {{ chart_data|json_script:"chart-data" }}
  <script>
    const charts = JSON.parse(document.getElementById("chart-data").textContent);

    new Chart(document.getElementById("breedingChart"), {
      type: "bar",
      data: {
        labels: charts.breeding_comparison.labels,
        datasets: [
          { label: "Conception %", data: charts.breeding_comparison.conception_rate, backgroundColor: "#2a7f62" },
          { label: "Stillbirth %", data: charts.breeding_comparison.stillbirth_rate, backgroundColor: "#b84545" },
          { label: "Calf Survival %", data: charts.breeding_comparison.calf_survival_rate, backgroundColor: "#f2b84b" }
        ]
      },
      options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
    });

    new Chart(document.getElementById("healthChart"), {
      type: "line",
      data: {
        labels: charts.health_correlation.labels,
        datasets: [{
          label: "Conception Rate %",
          data: charts.health_correlation.conception_rate,
          borderColor: "#132032",
          backgroundColor: "rgba(19,32,50,0.15)",
          fill: true,
          tension: 0.25
        }]
      },
      options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
    });
  </script>
</body>
</html>
